#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}ğŸ” Checking for git conflict markers...${NC}"
if grep -r "^<<<<<<< \|^>>>>>>> \|^=======$" src/; then
    echo "${RED}âŒ Git conflict markers found. Please resolve conflicts before committing.${NC}"
    exit 1
fi

echo "${BLUE}ğŸ” Checking for large files...${NC}"
# Check for files larger than 5MB
git diff --cached --name-only | while read file; do
    if [ -f "$file" ]; then
        filesize=$(stat -f%z "$file")
        if [ $filesize -gt 5242880 ]; then
            echo "${RED}âŒ File $file is larger than 5MB. Please check if this file should be committed.${NC}"
            exit 1
        fi
    fi
done

echo "${BLUE}ğŸ” Running TypeScript compilation check...${NC}"
npx tsc --noEmit || 
(
    echo "${RED}âŒ TypeScript compilation failed. Please fix type errors and try again.${NC}"
    false;
)

echo "${BLUE}ğŸ” Running ESLint on all files...${NC}"
npm run lint || 
(
    echo "${RED}âŒ ESLint check failed. Please fix the errors and try committing again.${NC}"
    false;
)

echo "${BLUE}ğŸ” Checking for npm audit issues...${NC}"
npm audit --audit-level=high || 
(
    echo "${RED}âš ï¸ High severity vulnerabilities found. Please run 'npm audit fix' or review security issues.${NC}"
    # Commenting out exit 1 to make this a warning only, uncomment if you want to block commits
    # exit 1
)

echo "${GREEN}âœ… All checks passed!${NC}"
npx lint-staged
